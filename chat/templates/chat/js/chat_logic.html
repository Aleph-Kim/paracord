<script type="text/javascript">
    function ChickChatForm__submit(form) {
        form.writer.value = form.writer.value.trim();

        const writer = form.writer.value;
        const body = form.body.value;
        const room_id = form.room_id.value;

        $.post(
            form.action,
            {
                csrfmiddlewaretoken: form.csrfmiddlewaretoken.value,
                writer,
                body,
                room_id
            },
            'json'
        );

        form.body.value = '';
        form.body.focus();
    }

    let ChickChat__lastMessageId = 0;
    let lastNickname;

    function ChickChat__loadMore() {
        $.get(
            "{% url 'chat:chat' room.id %}",
            {
                from_id: ChickChat__lastMessageId
            },
            function(data) {
                for ( const chatKey in data.chats ) {
                    const chat = data.chats[chatKey];
                    ChickChat__lastMessageId = chat.id;
                    ChickChat__renderMessage(chat);
                }
                console.log(1)
                setTimeout(ChickChat__loadMore, 200);
            },
            'json'
        );
    }

    function ChickChat__renderMessage(chat) {
        if (lastNickname != chat.nickname) {
            $('.chat-messages').append(`
            <div class="t-mb-2">
                <div class="t-text-xl t-text-white t-font-semibold">
                    ${chat.nickname}
                </div>
                ${chat.message}
            </div>`);
        }
        else {
            $('.chat-messages').append(`
            <div class="t-mb-2">
                ${chat.message}
            </div>`);
            }
        lastNickname = chat.nickname;
        var box_center = document.getElementById("box-center");
        //box_center.scrollTop = box_center.scrollHeight;
    }
    ChickChat__loadMore();


</script>
